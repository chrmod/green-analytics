<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" type="image/png" href="/static/favicon.png">

    <title> </title>

    <!-- Bootstrap core CSS -->
    <link href="/static/extern/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/static/style-log.css" rel="stylesheet">
  </head>

  <script>
    //window.onload = function() {

        var xhr = new XMLHttpRequest();
        xhr.open('GET','http://green-tracker.com/context.json');
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {

                var context = JSON.parse(xhr.responseText);
                render(context);
            }
        }
        xhr.send();

        var prepare = function(labels, ts) {
            var num = ts[0].length;
            var data = [];
            for(var j=1;j<num;j++) data.push([]);

            var h = {};
            for(var i=0;i<ts.length;i++) {
                h[ts[i][0]] = ts[i].splice(1, num);
            }

            console.log(h);
            for(var i=0;i<labels.length;i++) {
                for(var j=1;j<num;j++) {
                    if (h.hasOwnProperty(labels[i])) data[j-1][i] = h[labels[i]][j-1];
                    else data[j-1][i] = 0;
                }
            }

            return data;
        };



        var render = function(context) {
            console.log('helloe!!');

            document.getElementById('stats_min_ts').innerHTML = context['stats']['min_ts'];
            document.getElementById('stats_max_ts').innerHTML = context['stats']['max_ts'];

            document.getElementById('stats_new_all').innerHTML = context['stats']['new_all'];
            document.getElementById('stats_new_month').innerHTML = context['stats']['new_day'];
            document.getElementById('stats_new_day').innerHTML = context['stats']['new_month'];

            var table = document.getElementById('table_top_sites');

            Chart.defaults.global.animation = false;


            var n=Math.min(context['sites'].length, 3);
            for(var i=0;i<n;i++) {

                console.log('i',i);
                var item = context['sites'][i];

                var row = table.insertRow();

                var cell1 = row.insertCell(0);
                cell1.innerHTML = item['s'];
                var cell2 = row.insertCell(1);
                cell2.innerHTML = item['num_visits'];
                var cell3 = row.insertCell(2);
                cell3.innerHTML = item['num_loads'];

                var cell4 = row.insertCell(3);

                var div = document.createElement('div');
                cell4.appendChild(div);
                var canvas = document.createElement('canvas');
                canvas.id='top_site_'+i;
                canvas.height=250;
                canvas.width=500;

                div.appendChild(canvas);

                var divleg = document.createElement('div');

                divleg.innerHTML = '<div id="js-legend" class="chart-legend"></div>';
                div.appendChild(divleg);

                //cell4.innerHTML = '<canvas id="canvas-site-"+i height="150" width="400"></canvas>'
                //var canvas = document.getElementById("canvas-site-"+i);
               // console.log('canvas',canvas);

                var datalines = prepare(context['stats']['time_labels'], item['timeseries']);

                var lineData = {
                    labels: context['stats']['time_labels'],
                    datasets : [
				        {
					        label: "Page visits (uniques)",
					        data: datalines[0],
					        label: "Page visits (uniques)",
					        strokeColor: "rgba(151,10,10,1)",
					        pointColor: "rgba(151,10,10,1)"

                        },
                        {
                            label: "Page loads",
                            data: datalines[1],
                            label: "Page loads",
                            strokeColor: "rgba(10,151,10,1)",
                            pointColor: "rgba(10,151,10,1)",
                        }
                    ]
                };

                var oo  = new Chart(canvas.getContext("2d")).Line(lineData, {
			        //responsive: true,
                    datasetFill : false,
                    tooltipTemplate: "<%= PEASE value %>%",
		        });

		        //var divleg = document.createElement('div');
		        //divleg.class = "chart-legend";
		        //divleg.innerHTML = oo.generateLegend();
                //div.appendChild(divleg);

                document.getElementById('js-legend').innerHTML = oo.generateLegend();

		        console.log(canvas, oo);
            };

        }



    //}
  </script>

  <body>
    <div class="row container-fluid">
        <h1>Welcome to the Greentracker Reports</h1>

        <p>This report is built using the data collected by you on the in-vitro experiment. The raw data is available at <code>logs/collect.jl</code>. If you want to
        restart from scratch just deleted the log file, restart <code>server.py</code>, and spend some time clicking around.

        <p>The current tracking depicts page impressions, unique visitors, correlation across sites, patterns within site, goal achievements, returning customers, an even per-user aggregated statistics.

        <p>Needless to say that this analytics are short of a toy example, but they cover the most typical use-cases which typically require tracking the user. Needless to say, <b>to generate this report we
        did NOT require to compromise the privacy of the user in any way.</b>


        <h3>1) Basic Stats</h3>

        <p>We can get measures across a whole population, e.g. the number of MAU, DAU internet users in Germany.

        <p>During the time of the experiment, from <span id="stats_min_ts"></span>  to <span id="stats_max_ts"></span>  we have seen:
        <ul>
            <li> <span id="stats_new_all"></span> totally new users (never seen before in any site)
            <li> <span id="stats_new_day"></span> unique users by day (all sites, across all days)
            <li> <span id="stats_new_month"></span> unique users by month (all sites, across all months)
        </ul>

        <h3>2) Top 3 sites</h3>

        <p>We can measure popularity of sites, both as page loads but naturally as unique visitors too. We can also generate timeseries of the traffic.

            <table class="table table-striped ">
                <thead>
                <tr>
                     <th>Site Name</th>
                     <th>Total Unique Visits</th>
                     <th>Total Loads</th>
                     <th>Timeseries by hours (time, unique visits, loads)</th>
                     <th>Returning users</th>

                </tr>
                </thead>
                <tbody id="table_top_sites">

                </tbody>
            </table>

        <h3>2) Top 10 pages</h3>

        <p>We can have the same popularity rankings based on pages (segmented by site or not).

            <table class="table table-striped ">
                <thead>
                <tr>
                     <th>Site Name</th>
                     <th>Total Unique Visits</th>
                     <th>Total Loads</th>
                     <th>Timeseries by hours (time, visits, loads)</th>

                </tr>
                </thead>
                <tbody>
                {% for item in context.pages %}
                <tr>
                   <td>{{ item['s'] }}</td>
                   <td>{{ item['num_visits'] }}</td>
                   <td>{{ item['num_loads'] }}</td>
                   <td><pre>{{item['timeseries'] }}</pre></td>
                </tr>
                {% endfor %}
                </tbody>
            </table>

        <h3>3) Top-3 Site Correlations</h3>

        <p>Without profiling the user we can obtain useful data about relationships between sites. In here we measure
            the most popular co-ocurrences of sites by unique users, e.g. users visiting in the same session both focus.de and bild.de.

            <table class="table table-striped ">
                <thead>
                <tr>
                     <th>Pairwise Correlation</th>
                     <th>Total Unique Visits</th>
                     <th>Timeseries by hours (time, unique users)</th>
                </tr>
                </thead>
                <tbody>
                {% for item in context.correlations %}
                <tr>
                   <td>{{ item['s'] }}</td>
                   <td>{{ item['num_visits'] }}</td>
                   <td><pre>{{item['timeseries'] }}</pre></td>
                </tr>
                {% endfor %}
                </tbody>
            </table>


        <h3>4) Top-10 Click Patterns</h3>

        <p>We can also capture click-through patterns, to safe-guard the privacy of the user we limited to length 3 and we
            omitted the transitions between different sites. This information although not the full picture allow us to
            get a good understanding of where the traffic to a specific pages comes from (if that was across sites, we can achieve
            the same goal with the goals as we will see later on).

            <table class="table table-striped ">
                <thead>
                <tr>
                     <th>Click-through Patterns</th>
                     <th>Total Unique Visits</th>
                     <th>Timeseries by hours (time, unique users)</th>
                </tr>
                </thead>
                <tbody>
                {% for item in context.patterns %}
                <tr>
                   <td>{{ item['s'] }}</td>
                   <td>{{ item['num_visits'] }}</td>
                   <td><pre>{{item['timeseries'] }}</pre></td>
                </tr>
                {% endfor %}
                </tbody>
            </table>


        <h3>5) Goals</h3>

        <p>We can also obtain without collecting all navigation of the user complex analytics like goal achievements.

        <p>We have
            defined one goal in the experiment: a visit to page 10 in site 4, after visiting page 9 in the same site or visiting
            page 10 in site 5. For the goal to be achieve the user must complete it before 20 minutes or doing less that 4 page
            visits in between. This setup is typical of advertisement, you can think of the goal page as a successful signup page
            and the two initiators as pages containing ads for the signup.


        <table class="table table-striped ">
                <thead>
                <tr>
                     <th>Goal</th>
                     <th>Total Successes</th>
                     <th>Sources Breakdown (time, number of conversions, conversion rate)</th>
                </tr>
                </thead>
                <tbody>
                {% for item in context.goals %}
                <tr>
                   <td>{{ item['s'] }}</td>
                   <td>{{ item['num_succ'] }}</td>
                   <td><pre>{{item['timeseries'] }}</pre></td>
                </tr>
                {% endfor %}
                </tbody>
            </table>

    </div>

  </body>
  <script src="/static/extern/Chart.min.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script> -->
</html>
